using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.DeadSpace.Virus;
using System.Linq;
using Robust.Shared.Utility;

namespace Content.Client.DeadSpace.Virus.UI;

[GenerateTypedNameReferences]
public sealed partial class VirusDiagnoserConsoleWindow : DefaultWindow
{
    private VirusDiagnoserConsoleBoundUserInterfaceState? _lastUpdate;

    public VirusDiagnoserConsoleWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        // Подписываемся на выбор штамма, чтобы кнопки обновлялись
        StrainList.OnItemSelected += _ =>
        {
            UpdateServerTabButtons();
        };
    }

    public void Populate(VirusDiagnoserConsoleBoundUserInterfaceState state)
    {
        _lastUpdate = state;

        var amountMsg = new FormattedMessage();
        amountMsg.AddMarkupOrThrow(Loc.GetString("research-console-menu-research-points-text",
            ("points", state.Points)));
        ResearchAmountLabel.SetMessage(amountMsg);

        // Состояние 1: анализатор веществ недоступен
        if (!state.SolutionAnalyzerConnected)
        {
            SolutionAnalyzerMissing.Visible = true;
            SolutionAnalyzerFar.Visible = false;
            SolutionAnalyzerContents.Visible = false;
        }
        // Состояние 2: анализатор веществ далеко
        else if (!state.SolutionAnalyzerInRange)
        {
            SolutionAnalyzerMissing.Visible = false;
            SolutionAnalyzerFar.Visible = true;
            SolutionAnalyzerContents.Visible = false;
        }
        // Состояние 3: анализатор веществ доступен
        else
        {
            SolutionAnalyzerMissing.Visible = false;
            SolutionAnalyzerFar.Visible = false;
            SolutionAnalyzerContents.Visible = true;
        }

        // Состояние 1: сервер недоступен
        if (!state.DataServerConnected)
        {
            ServerMissing.Visible = true;
            ServerFar.Visible = false;
            ServerContents.Visible = false;
        }
        // Состояние 2: сервер далеко
        else if (!state.DataServerInRange)
        {
            ServerMissing.Visible = false;
            ServerFar.Visible = true;
            ServerContents.Visible = false;
        }
        // Состояние 3: сервер доступен
        else
        {
            ServerMissing.Visible = false;
            ServerFar.Visible = false;
            ServerContents.Visible = true;

            // Обновление списка штаммов
            StrainList.Clear();

            foreach (var record in state.Strains)
            {
                StrainList.AddItem(record.Strain + "-" + record.Time);
            }

            UpdateServerTabButtons();
        }

        if (!state.DiagnoserConnected)
        {
            DiagnoserMissing.Visible = true;
            DiagnoserFar.Visible = false;
            DiagnoserContents.Visible = false;
        }
        else if (!state.DiagnoserInRange)
        {
            DiagnoserMissing.Visible = false;
            DiagnoserFar.Visible = true;
            DiagnoserContents.Visible = false;
        }
        else
        {
            DiagnoserMissing.Visible = false;
            DiagnoserFar.Visible = false;
            DiagnoserContents.Visible = true;
        }
    }

    private void UpdateServerTabButtons()
    {
        var selectedItems = StrainList.GetSelected();

        // Кнопки недоступны, если ничего не выбрано
        bool nothingSelected = !selectedItems.Any();
        DeleteStrainButton.Disabled = nothingSelected;
        PrintReportButton.Disabled = nothingSelected;
        GenerateVirusButton.Disabled = nothingSelected;
    }

}
