name: "Changelog: Send discord webhook"

on:
  pull_request_target:
    types: [closed]

jobs:
  send-discord:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Extract PR details
        id: extract
        run: |
          BODY=$(printf '%s' "${{ github.event.pull_request.body }}" | base64 -w0)
          echo "DESCRIPTION_B64=$BODY" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "REPO=${{ github.repository }}" >> $GITHUB_OUTPUT

      - name: Parse PR and Format Text
        id: parse_step
        env:
          DESCRIPTION_B64: ${{ steps.extract.outputs.DESCRIPTION_B64 }}
          PR_NUMBER: ${{ steps.extract.outputs.PR_NUMBER }}
          REPO: ${{ steps.extract.outputs.REPO }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          python <<'EOF'
          import re, os, base64

          desc_b64 = os.environ.get("DESCRIPTION_B64", "")
          desc = base64.b64decode(desc_b64).decode("utf-8", errors="replace")
          pr_num = os.environ.get("PR_NUMBER")
          repo = os.environ.get("REPO")
          author = os.environ.get("AUTHOR")

          desc_clean = re.sub(r'<!--.*?-->', '', desc, flags=re.DOTALL)

          if ":cl:" not in desc_clean or ":v:" not in desc_clean:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("should_send=false\n")
              exit(0)

          sections = {
              "–î–æ–±–∞–≤–ª–µ–Ω–æ": "üÜï",
              "–£–¥–∞–ª–µ–Ω–æ": "‚ùå",
              "–ò–∑–º–µ–Ω–µ–Ω–æ": "‚öíÔ∏è",
              "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ": "üêõ",
          }

          pr_link = f"[#{pr_num}](<https://github.com{repo}/pull/{pr_num}>)"
          content_lines = [f"**{author}** updated:"]

          found_any = False
          for title, emoji in sections.items():
              pattern = rf"- {title}:\s*(.*?)(?=\n- [^:]|$)"
              match = re.search(pattern, desc_clean, flags=re.DOTALL)
              if match:
                  block = match.group(1).strip()
                  lines = [l.strip("- ").strip() for l in block.splitlines() if l.strip()]
                  for line in lines:
                      content_lines.append(f"{emoji} - {line} ({pr_link})")
                      found_any = True

          if not found_any:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("should_send=false\n")
              exit(0)

          full_message = "\n".join(content_lines)

          with open("discord_msg.txt", "w", encoding="utf-8") as f:
              f.write(full_message)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write("should_send=true\n")
          EOF

      - name: Send to Discord
        if: steps.parse_step.outputs.should_send == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.CHANGELOG_DISCORD_WEBHOOK }}
        run: |
          MESSAGE_TEXT=$(cat discord_msg.txt)

          jq -n --arg msg "$MESSAGE_TEXT" '{
            "username": "–°–æ—é–∑-1",
            "content": $msg,
            "allowed_mentions": { "parse": [] }
          }' | curl -X POST \
            -H "Content-Type: application/json" \
            -d @- \
            "$WEBHOOK_URL" \
            --fail \
            --silent
