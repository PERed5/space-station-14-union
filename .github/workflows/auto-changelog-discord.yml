name: "Changelog: Send discord webhook"

on:
  pull_request_target:
    types: [closed]

jobs:
  send-discord:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    outputs:
      should_send: ${{ steps.check-commented.outputs.should_send }}

    steps:
      - name: Extract PR details
        id: extract
        run: |
          BODY=$(printf '%s' "${{ github.event.pull_request.body }}" | base64 -w0)
          echo "DESCRIPTION_B64=$BODY" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "REPO=${{ github.repository }}" >> $GITHUB_OUTPUT

      - name: Check commented
        id: check-commented  # –í–∞–∂–Ω–æ: –∑–∞–¥–∞—ë–º id –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ outputs
        env:
          DESCRIPTION_B64: ${{ steps.extract.outputs.DESCRIPTION_B64 }}
        run: |
          python <<'EOF'
          import re, os
          import base64

          desc_b64 = os.environ.get("DESCRIPTION_B64", "")
          desc = base64.b64decode(desc_b64).decode("utf-8", errors="replace")

          # –£–¥–∞–ª—è–µ–º –≤—Å–µ HTML-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ)
          desc = re.sub(r'<!--.*?-->', '', desc, flags=re.DOTALL)

          if ":cl:" not in desc:
              print("Skip (:cl:)")
              print("::set-output name=should_send::false")
              exit(0)
          else:
              print("::set-output name=should_send::true")

          EOF

      - name: Parse PR and build JSON with jq
        if: steps.check-commented.outputs.should_send == 'true'
        id: parse
        env:
          DESCRIPTION_B64: ${{ steps.extract.outputs.DESCRIPTION_B64 }}
          PR_NUMBER: ${{ steps.extract.outputs.PR_NUMBER }}
          AUTHOR: ${{ steps.extract.outputs.AUTHOR }}
          REPO: ${{ steps.extract.outputs.REPO }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          DESC=$(echo "$DESCRIPTION_B64" | base64 -d)
          DESC_CLEAN=$(echo "$DESC" | sed 's/<!--.*-->//g')

          ADDED=$(echo "$DESC_CLEAN" | grep -oP '(?<=- –î–æ–±–∞–≤–ª–µ–Ω–æ:).*' || echo "")
          REMOVED=$(echo "$DESC_CLEAN" | grep -oP '(?<=- –£–¥–∞–ª–µ–Ω–æ:).*' || echo "")
          CHANGED=$(echo "$DESC_CLEAN" | grep -oP '(?<=- –ò–∑–º–µ–Ω–µ–Ω–æ:).*' || echo "")
          FIXED=$(echo "$DESC_CLEAN" | grep -oP '(?<=- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:).*' || echo "")

          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º \n –≤ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
          ADDED=$(echo -e "$ADDED")
          REMOVED=$(echo -e "$REMOVED")
          CHANGED=$(echo -e "$CHANGED")
          FIXED=$(echo -e "$FIXED")

          # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏
          if [[ -z "$ADDED" && -z "$REMOVED" && -z "$CHANGED" && -z "$FIXED" ]]; then
            echo "No changes found. Skipping Discord notification."
            exit 0
          fi

          # –°–æ–∑–¥–∞—ë–º JSON —á–µ—Ä–µ–∑ jq —Å –ø–æ–ª—è–º–∏ (fields) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          PAYLOAD=$(jq -n \
            --arg title "–ò–∑–º–µ–Ω–µ–Ω–∏–µ (PR #$PR_NUMBER)" \
            --arg url "https://github.com/$REPO/pull/$PR_NUMBER" \
            --arg author "$AUTHOR" \
            --arg footer "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
            --arg added "$ADDED" \
            --arg removed "$REMOVED" \
            --arg changed "$CHANGED" \
            --arg fixed "$FIXED" \
            '{
              "username": "–ö–∞–ø–∏–±–∞—Ä–∫–∞ –ú–ö-–ò–∑–º–µ–Ω–µ–Ω–∏—è",
              "embeds": [
                {
                  "color": 3300375,
                  "title": $title,
                  "url": $url,
                  "fields": [
                    { "name": "üÜï –î–æ–±–∞–≤–ª–µ–Ω–æ:", "value": $added, "inline": false },
                    { "name": "‚ùå –£–¥–∞–ª–µ–Ω–æ:", "value": $removed, "inline": false },
                    { "name": "‚öíÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ:", "value": $changed, "inline": false },
                    { "name": "üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:", "value": $fixed, "inline": false },
                    { "name": "üë§ –ê–≤—Ç–æ—Ä:", "value": $author, "inline": false }
                  ],
                  "footer": {
                    "text": $footer
                  }
                }
              ]
            }')

          echo "$PAYLOAD" > /tmp/discord_payload.json
          echo "PAYLOAD_FILE=/tmp/discord_payload.json" >> $GITHUB_OUTPUT

      - name: Send to Discord
        if: |
          steps.parse.outcome == 'success' &&
          steps.parse.outputs.PAYLOAD_FILE != '' &&
          steps.check-commented.outputs.should_send == 'true'
        env:
          PAYLOAD_FILE: ${{ steps.parse.outputs.PAYLOAD_FILE }}
          WEBHOOK_URL: ${{ secrets.CHANGELOG_DISCORD_WEBHOOK }}
        run: |
          PAYLOAD=$(cat "$PAYLOAD_FILE")

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL" \
            --fail \
            --silent \
            --show-error
