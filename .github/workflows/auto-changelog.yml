name: "Changelog: Update changelog"
permissions:
  contents: write

on:
  pull_request_target:
    types: [closed]

jobs:
  changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout changelog branch
        uses: actions/checkout@v4
        with:
          ref: changelog
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Extract PR description
        id: extract
        run: |
          BODY=$(cat << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          echo "DESCRIPTION<<EOF" >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Parse PR description and update changelog
        run: |
          python <<'EOF'
          import yaml
          import re
          import os
          from datetime import datetime, timezone
          import sys
          import logging

          logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
          logger = logging.getLogger(__name__)

          CHANGELOG = "Resources/Changelog/ChangelogDS14Soyuz.yml"

          desc = os.environ.get("DESCRIPTION", "")
          author = os.environ.get("AUTHOR", "unknown")
          pr = os.environ.get("PR_NUMBER", "0")

          logger.info(f"Processing PR #{pr} from {author}")

          if not desc:
              logger.error("PR description is empty")
              sys.exit(1)

          desc = re.sub(r'<!--.*?-->', '', desc, flags=re.DOTALL)
          if ":cl:" not in desc:
              logger.info("No :cl: found — skipping")
              sys.exit(0)

          sections = {
              "Добавлено": "Add",
              "Удалено": "Remove",
              "Изменено": "Tweak",
              "Исправлено": "Fix",
          }

          changes = []
          found_sections = False

          for title, type_key in sections.items():
              pattern = rf"- ?\*?{title}\*?:?\s*(.*?)(?=\n-|$)"
              matches = re.findall(pattern, desc, flags=re.DOTALL | re.IGNORECASE)

              for match in matches:
                  if match.strip():
                      found_sections = True
                      lines = [line.strip('- *').strip() for line in match.split('\n') if line.strip()]
                      message = ' '.join(lines)
                      message = re.sub(r'\s+', ' ', message).strip()

                      if message and len(message) > 2:
                          changes.append({
                              "type": type_key,
                              "message": message
                          })
                          logger.info(f"Found change: {type_key} - {message}")

          if not changes:
              if found_sections:
                  logger.warning("Sections found but no valid changes extracted")
              else:
                  logger.warning("No valid changes found")
              sys.exit(0)

          try:
              if os.path.exists(CHANGELOG) and os.path.getsize(CHANGELOG) > 0:
                  with open(CHANGELOG, "r", encoding="utf-8") as f:
                      data = yaml.safe_load(f) or {}
                  logger.info(f"Loaded existing changelog")
              else:
                  data = {}
                  logger.info("Creating new changelog file")
          except yaml.YAMLError as e:
              logger.error(f"Error parsing YAML: {e}")
              if os.path.exists(CHANGELOG):
                  os.rename(CHANGELOG, f"{CHANGELOG}.backup")
              data = {}
          except Exception as e:
              logger.error(f"Unexpected error: {e}")
              data = {}

          if "Entries" not in data:
              data["Entries"] = []

          entries = data["Entries"]
          last_id = max((e.get("id", 0) for e in entries), default=0)

          new_entry = {
              "id": last_id + 1,
              "author": author,
              "time": datetime.now(timezone.utc).isoformat(),
              "pr": int(pr),
              "changes": changes
          }

          entries.append(new_entry)
          logger.info(f"Added entry #{last_id + 1} with {len(changes)} changes")

          try:
              with open(CHANGELOG, "w", encoding="utf-8") as f:
                  yaml.dump(
                      data,
                      f,
                      allow_unicode=True,
                      sort_keys=False,
                      indent=2,
                      default_flow_style=False,
                      width=1000
                  )
              logger.info("Changelog saved successfully")
          except Exception as e:
              logger.error(f"Error saving changelog: {e}")
              sys.exit(1)

          EOF
        env:
          DESCRIPTION: ${{ env.DESCRIPTION }}
          AUTHOR: ${{ env.AUTHOR }}
          PR_NUMBER: ${{ env.PR_NUMBER }}

      - name: Commit and push to changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -f "Resources/Changelog/ChangelogDS14Soyuz.yml" ]; then
            git add Resources/Changelog/ChangelogDS14Soyuz.yml
          else
            echo "Changelog file not found!"
            exit 1
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Changelog: PR #${{ github.event.pull_request.number }}"

          max_retries=3
          retry_count=0
          until git pull --rebase origin changelog; do
            retry_count=$((retry_count + 1))
            if [ $retry_count -ge $max_retries ]; then
              echo "Failed to rebase after $max_retries attempts"
              exit 1
            fi
            echo "Rebase failed, retrying in 5 seconds..."
            sleep 5
          done

          git push origin changelog
